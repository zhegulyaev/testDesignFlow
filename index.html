<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DesignFlow — Cloud Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --accent: #7c5cff;
      --accent-hover: #6a4bff;
      --text: #1e293b;
      --text-muted: #64748b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.05);
      --red: #ef4444;
      --orange: #f97316;
      --green: #22c55e;
      --celebrate-start: #facc15;
      --celebrate-end: #34d399;
      --fav-gold: #fbbf24;
    }

    body[data-theme="dark"] {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --border: #334155;
      background: #020617;
      --celebrate-start: #facc15;
      --celebrate-end: #22c55e;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
      overflow-y: scroll;
    }

    /* --- AUTH SCREEN STYLES --- */
    #auth-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.3s;
    }
    
    .auth-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 40px;
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    
    .auth-logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fbbf24;
        font-size: 28px;
        margin: 0 auto 20px;
        box-shadow: 0 4px 15px rgba(124, 92, 255, 0.3);
    }
    
    .auth-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; color: var(--text); }
    .auth-subtitle { color: var(--text-muted); font-size: 14px; margin-bottom: 30px; line-height: 1.5; }
    
    .auth-btn {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: .2s;
        margin-bottom: 12px;
    }
    .auth-btn:hover { background: #f8fafc; border-color: var(--border); transform: translateY(-1px); }
    body[data-theme="dark"] .auth-btn:hover { background: #334155; }
    
    .auth-btn.google {
        background: #fff; color: #1f2937;
        border-color: #e5e7eb;
    }
    .auth-btn.google:hover { background: #f9fafb; }
    body[data-theme="dark"] .auth-btn.google { background: #1e293b; color: #fff; border-color: #334155; }
    body[data-theme="dark"] .auth-btn.google:hover { background: #334155; }

    /* --- APP CONTENT (Hidden by default) --- */
    #app-content { display: none; }

    /* --- SHARED STYLES --- */
    .header-wrapper { margin-top: 24px; background: var(--bg); border-bottom: 1px solid var(--border); }
    .header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; max-width: 1200px; margin: 0 auto; }
    
    .logo-container { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 20px; }
    .logo-text h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--accent); line-height: 1; }
    .logo-text h1 span { font-size: 13px; color: var(--text-muted); font-weight: 600; margin-left: 6px; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }
    body[data-theme="dark"] .logo-text h1 span { background: #334155; }
    .logo-text p { margin: 4px 0 0; font-size: 12px; font-weight: 600; color: var(--text-muted); }

    .btn { padding: 9px 16px; border-radius: 10px; background: #f1f5f9; color: var(--text); font-size: 13px; cursor: pointer; font-weight: 600; border: 1px solid transparent; transition: .2s; display: flex; align-items: center; gap: 8px; text-decoration: none; white-space: nowrap; }
    body[data-theme="dark"] .btn { background: #334155; border-color: #475569; }
    .btn:hover { background: #e2e8f0; }
    body[data-theme="dark"] .btn:hover { background: #475569; }
    .btn.primary { background: var(--accent); color: white; border: none; }
    .btn.primary:hover { background: var(--accent-hover); }
    .btn.secondary { background: transparent; border: 1px solid var(--border); }
    .btn.secondary:hover { background: #f8fafc; }
    body[data-theme="dark"] .btn.secondary:hover { background: #1e293b; }
    .btn.danger { background: #fee2e2; color: var(--red); }
    .btn.danger:hover { background: #fecaca; }

    .btn-icon { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 6px; transition: .2s; display: flex; align-items: center; justify-content: center; }
    .btn-icon:hover { background: #f1f5f9; color: var(--text); }
    body[data-theme="dark"] .btn-icon:hover { background: #334155; color: var(--text); }
    .btn-icon.del:hover { background: #fee2e2; color: var(--red); }
    body[data-theme="dark"] .btn-icon.del:hover { background: #450a0a; color: #f87171; }

    .tabs-wrapper { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    .tabs { display: flex; gap: 6px; padding: 20px 0 0; flex-wrap: wrap; }
    .tab { padding: 8px 14px; border-radius: 8px; background: transparent; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; transition: .2s; }
    .tab:hover { background: rgba(0,0,0,0.03); }
    body[data-theme="dark"] .tab:hover { background: rgba(255,255,255,0.05); }
    .tab.active { background: #e0e7ff; color: var(--accent); }
    body[data-theme="dark"] .tab.active { background: rgba(124, 92, 255, 0.2); }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px 60px; }
    .grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; margin-top: 20px; align-items: start; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); }
    .card h2 { font-size: 18px; font-weight: 700; margin: 0 0 20px; display: flex; align-items: center; gap: 8px;}
    .card h2 i { color: var(--accent); }

    .form-row { display: flex; gap: 12px; margin-bottom: 14px; }
    .form-row > * { flex: 1; }
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    label { font-size: 12px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    input, textarea, select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); font-size: 14px; color: var(--text); outline: none; width: 100%; box-sizing: border-box; transition: border-color .2s; }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: var(--card-bg); }
    body[data-theme="dark"] input, body[data-theme="dark"] textarea, body[data-theme="dark"] select { background: #0f172a; }
    body[data-theme="dark"] input:focus { background: #1e293b; }
    textarea { min-height: 80px; resize: vertical; font-family: inherit; }
    
    .custom-days-field { display: none; margin-top: 10px; }
    .btn-group { display: flex; gap: 10px; margin-top: 16px; }
    .btn-group .btn { flex: 1; justify-content: center; padding: 12px; }

    .goal-list { display: flex; flex-direction: column; gap: 16px; }
    .goal-card { border: 1px solid var(--border); border-radius: 16px; padding: 20px; background: var(--card-bg); transition: transform .2s, box-shadow .2s; position: relative; cursor: pointer; }
    .goal-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    .goal-card.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(124, 92, 255, 0.2), var(--shadow); background: rgba(124, 92, 255, 0.02); }
    .goal-card.done { border-color: var(--celebrate-end); opacity: 0.8; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3); background: #f0fdf4; }
    body[data-theme="dark"] .goal-card.done { background: #064e3b; border-color: #34d399; }
    
    .goal-header { display: flex; justify-content: space-between; align-items: start; gap: 10px; }
    .goal-title-wrapper { display: flex; align-items: flex-start; gap: 8px; }
    .goal-title { font-size: 18px; font-weight: 700; line-height: 1.3; color: var(--text); }
    .star-icon { color: #cbd5e1; cursor: pointer; transition: transform 0.2s, color 0.2s; height: 24px; display: flex; align-items: center; }
    .star-icon.active, .star-icon:hover { color: var(--fav-gold); transform: scale(1.1); }
    .pin-icon { color: #cbd5e1; cursor: pointer; transform: rotate(45deg); height: 24px; margin-top: 4px; }
    .pin-icon.active, .pin-icon:hover { color: var(--accent); }

    .goal-meta { display: flex; gap: 12px; align-items: center; margin: 10px 0; font-size: 13px; color: var(--text-muted); }
    .goal-meta > span { color: var(--text); font-weight: 600; }

    .priority-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; display: inline-flex; align-items: center; gap: 6px; }
    .priority-high { background: #fee2e2; color: var(--red); }
    .priority-med { background: #ffedd5; color: var(--orange); }
    .priority-low { background: #dcfce7; color: var(--green); }
    body[data-theme="dark"] .priority-high { background: #450a0a; color: #f87171; }
    body[data-theme="dark"] .priority-med { background: #451a03; color: #fb923c; }
    body[data-theme="dark"] .priority-low { background: #064e3b; color: #34d399; }

    .progress-bar { height: 8px; background: #e2e8f0; border-radius: 999px; overflow: hidden; margin: 16px 0 10px; }
    body[data-theme="dark"] .progress-bar { background: #334155; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #c084fc); transition: width .5s; }
    .progress-bar.done .progress-fill { background: linear-gradient(90deg, #facc15, #fbbf24, #f59e0b, #d97706); background-size: 200% 100%; animation: shine 3s infinite linear; }
    @keyframes shine { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

    .numbers { display: flex; justify-content: space-between; font-size: 15px; font-weight: 700; margin-bottom: 16px; }
    .numbers span:last-child { color: var(--text-muted); font-weight: 500; font-size: 14px; }

    .quick-add { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .quick-btn { padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .quick-btn:hover { border-color: var(--accent); color: var(--accent); }
    body[data-theme="dark"] .quick-btn { background: #334155; border-color: #475569; }

    .actions-row { display: flex; gap: 10px; border-top: 1px solid var(--border); padding-top: 16px; }
    .action-icon-btn { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-muted); background: transparent; border: none; display: flex; align-items: center; gap: 6px; font-weight: 500; }
    .action-icon-btn:hover { background: #f1f5f9; color: var(--text); }
    .action-icon-btn.delete:hover { background: #fee2e2; color: var(--red); }
    body[data-theme="dark"] .action-icon-btn:hover { background: #334155; color: var(--text); }
    body[data-theme="dark"] .action-icon-btn.delete:hover { background: #450a0a; color: #f87171; }

    /* KPI */
    .kpi { display: flex; justify-content: space-between; gap: 15px; margin-top: 16px; text-align: center; }
    .kpi-item { flex: 1; position: relative; }
    .kpi-item:not(:last-child)::after { content: ''; position: absolute; right: -8px; top: 5px; bottom: 5px; width: 1px; background: var(--border); }
    .kpi-value { font-size: 20px; font-weight: 700; color: var(--text); line-height: 1.1; }
    .kpi-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-weight: 600; text-transform: uppercase; }

    /* Multi Action */
    .multi-action-bar { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px 20px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; gap: 15px; box-shadow: var(--shadow); }
    .multi-action-text { font-size: 14px; font-weight: 600; color: var(--text-muted); }
    .multi-action-btns { display: flex; gap: 10px; flex-shrink: 0; }

    /* Modals & Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 14px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 200; display: flex; align-items: center; gap: 12px; opacity: 0; transform: translateY(20px); transition: all .3s; font-size: 14px; }
    body[data-theme="dark"] .toast { background: #1e293b; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .toast.show { opacity: 1; transform: translateY(0); }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); align-items: center; justify-content: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card-bg); border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp .3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
    .modal-close { font-size: 20px; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 24px; }
    .modal-actions { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
    
    .confetti-icon { font-size: 50px; color: var(--celebrate-start); animation: pulse 1s infinite alternate; }
    @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
    .congrats-actions { display: flex; gap: 10px; width: 100%; }
    .congrats-actions .btn { flex: 1; justify-content: center; padding: 12px; }

    /* History styles */
    .history-filter-container { display: flex; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
    .history-group-header { font-size: 12px; font-weight: 700; color: var(--accent); text-transform: uppercase; margin: 20px 0 10px; display: flex; align-items: center; justify-content: space-between; }
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .history-info { display: flex; flex-direction: column; gap: 4px; }
    .history-date { font-size: 11px; color: var(--text-muted); }
    .history-comment { font-size: 13px; font-weight: 600; color: var(--text); }
    .history-amount { font-weight: 700; font-size: 14px; }
    .history-amount.plus { color: var(--green); }
    .history-amount.minus { color: var(--red); }
    .empty-message { text-align: center; padding: 50px; color: var(--text-muted); font-size: 15px; display: flex; flex-direction: column; align-items: center; gap: 12px; }

    @media (max-width: 600px) {
        .desktop-only { display: none; }
        .multi-action-btns .btn { font-size: 0; padding: 8px 12px; }
        .multi-action-btns .btn i { font-size: 14px; margin: 0; }
    }
    @media (min-width: 601px) { .desktop-only { display: inline; } }
  </style>
</head>
<body>

  <div id="auth-screen">
      <div class="auth-card">
          <div class="auth-logo"><i class="fa-solid fa-bolt"></i></div>
          <div class="auth-title">Добро пожаловать</div>
          <div class="auth-subtitle">
              Войдите, чтобы синхронизировать ваши цели.<br>
              Все данные хранятся в защищенном облаке.
          </div>
          
          <button id="auth-btn-google" class="auth-btn google">
              <i class="fa-brands fa-google"></i> Войти через Google
          </button>
          
          <div style="margin-top:20px; font-size:12px; color:var(--text-muted)">
              DesignFlow Tracker v0.5 (Cloud Only)
          </div>
      </div>
  </div>

  <div id="app-content">
      <div class="header-wrapper">
        <div class="header">
          <div class="logo-container">
            <div class="logo-icon"><i class="fa-solid fa-bolt"></i></div>
            <div class="logo-text">
              <h1>DesignFlow <span>Cloud</span></h1>
              <p id="user-email-display">user@example.com</p>
            </div>
          </div>
          <div class="header-actions">
            <a href="https://zhegulyaev.github.io/DesignFlow/" class="btn secondary">
              <i class="fa-solid fa-list-check"></i> <span class="desktop-only">Проекты</span>
            </a>
            <button class="btn" id="theme-btn"><i class="fa-solid fa-moon"></i></button>
            <button id="btn-logout" class="btn secondary" title="Выйти"><i class="fa-solid fa-right-from-bracket"></i></button>
          </div>
        </div>
      </div>

      <div class="tabs-wrapper">
        <div class="tabs">
          <div class="tab active" data-filter="active">Активные <span class="count" id="active-count">0</span></div>
          <div class="tab" data-filter="favorite"><i class="fa-solid fa-star" style="color: #fbbf24;"></i> Избранное <span class="count" id="fav-count">0</span></div>
           <div class="tab" data-filter="done">Завершённые <span class="count" id="done-count">0</span></div>
          <div class="tab" data-filter="all">Все цели <span class="count" id="total-count">0</span></div>
          <div class="tab" data-filter="trash">Корзина <span class="count" id="trash-count">0</span></div>
        </div>
      </div>

      <div class="container grid">
        <div class="card">
          <h2><i class="fa-solid fa-square-plus"></i> Создать цель</h2>
          
          <div class="field">
            <label>Название</label>
            <input id="g-title" placeholder="Например: Новый MacBook" />
          </div>

          <div class="form-row">
            <div class="field">
              <label>Сумма</label>
              <input id="g-target" placeholder="100 000 или 100к" inputmode="numeric" />
            </div>
            <div class="field">
              <label>Есть</label>
              <input id="g-current" placeholder="0 или 50к" inputmode="numeric" />
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label>Дедлайн</label>
              <input id="g-deadline" type="date" />
            </div>
            <div class="field">
              <label>Приоритет</label>
              <select id="g-priority">
                <option value="med">Средний</option>
                <option value="high">Высокий</option>
                <option value="low">Низкий</option>
              </select>
            </div>
          </div>
          
          <div class="field">
            <label>Шаблон срока</label>
            <select id="g-template">
              <option value="">Выбрать быстрый срок...</option>
              <option value="7">Через неделю (7 дн.)</option>
              <option value="14">Через 2 недели (14 дн.)</option>
              <option value="30">Через месяц (30 дн.)</option>
              <option value="custom">Свой вариант...</option>
            </select>
            <div class="custom-days-field" id="g-custom-days-field">
              <input id="g-custom-days-input" type="number" min="1" placeholder="Введите кол-во дней" />
            </div>
          </div>

          <div class="field">
            <label>Заметка</label>
            <textarea id="g-notes" placeholder="План действий, ссылки, мысли..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn primary" id="btn-add"><i class="fa-solid fa-plus"></i> Добавить</button>
            <button class="btn secondary" id="btn-demo"><i class="fa-solid fa-wand-magic-sparkles"></i> Демо</button>
          </div>
        </div>

        <div>
           <div class="card" style="margin-bottom: 24px; padding: 20px;">
            <h2 style="font-size: 15px; margin-bottom:12px; color:var(--text-muted); font-weight:600;"><i class="fa-solid fa-chart-pie"></i> Общий прогресс</h2>
            <div class="progress-bar" style="margin-top:0"><div class="progress-fill" id="overall-progress" style="width:0%"></div></div>
            <div style="font-size:13px; color:var(--text-muted); text-align:right; margin-top:8px;" id="overall-text">0%</div>
          </div>
          
          <div class="multi-action-bar" id="multi-action-bar" style="display: none;">
              <div class="multi-action-text" id="multi-action-text">Выбрано: 0</div>
              <div class="multi-action-btns">
                  <button class="btn secondary" id="btn-select-all"><i class="fa-solid fa-list-check"></i> <span class="desktop-only">Выбрать все</span></button>
                  <button class="btn" id="btn-multi-done" title="Завершить"><i class="fa-solid fa-check"></i> <span class="desktop-only">Готово</span></button>
                  <button class="btn danger" id="btn-multi-trash" title="В корзину"><i class="fa-regular fa-trash-can"></i> <span class="desktop-only">В корзину</span></button>
              </div>
          </div>
          <div class="goal-list" id="goals-list"></div>
        </div>
      </div>
      
      <div class="footer">DesignFlow Tracker by <a href="https://t.me/r_zhegulyaev" target="_blank">Zhegulyaev</a></div>
  </div>

  <div class="toast" id="toast">
    <i class="fa-solid fa-circle-check"></i> <span id="toast-message"></span>
  </div>

  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Редактировать</h2><span class="modal-close"><i class="fa-solid fa-xmark"></i></span></div>
      <div class="modal-body">
        <div class="field"><label>Название</label><input id="edit-title" /></div>
        <div class="form-row">
          <div class="field"><label>Сумма</label><input id="edit-target" inputmode="numeric" /></div>
          <div class="field"><label>Есть сейчас</label><input id="edit-current" inputmode="numeric" /></div>
        </div>
        <div class="form-row">
          <div class="field"><label>Дедлайн</label><input id="edit-deadline" type="date" /></div>
          <div class="field"><label>Приоритет</label><select id="edit-priority"><option value="med">Средний</option><option value="high">Высокий</option><option value="low">Низкий</option></select></div>
        </div>
        <div class="field"><label>Заметка</label><textarea id="edit-notes"></textarea></div>
      </div>
      <div class="modal-actions"><button class="btn primary" id="save-edit">Сохранить</button></div>
    </div>
  </div>

  <div class="modal" id="progress-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header"><h2>Изменить баланс</h2><span class="modal-close"><i class="fa-solid fa-xmark"></i></span></div>
      <div class="modal-body">
        <div class="field"><label>Сумма операции</label><input id="progress-amount" inputmode="numeric" autofocus /></div>
        <div class="field"><label>Комментарий</label><input id="progress-comment" placeholder="Например: Потратил на отель" /></div>
      </div>
      <div class="modal-actions" style="justify-content: space-between;">
        <button class="btn danger" id="btn-subtract"><i class="fa-solid fa-minus"></i> Вычесть</button>
        <button class="btn primary" id="btn-add-progress"><i class="fa-solid fa-plus"></i> Добавить</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="history-modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="history-modal-title">История</h2><span class="modal-close"><i class="fa-solid fa-xmark"></i></span></div>
      <div class="modal-body">
        <div class="history-filter-container">
            <input id="history-date-filter" placeholder="Фильтр по дате..." readonly style="cursor: pointer; background: var(--bg);" />
            <button class="btn secondary" id="history-clear-filter"><i class="fa-solid fa-rotate-left"></i></button>
        </div>
        <div id="history-list-container" style="max-height: 50vh; overflow-y: auto;"></div>
        <div id="history-load-more-container" style="display:none; margin-top:15px;"><button class="btn secondary" id="btn-history-load-more" style="width:100%">Показать еще</button></div>
      </div>
      <div class="modal-actions"><button class="btn secondary modal-close">Закрыть</button></div>
    </div>
  </div>
  
  <div class="modal" id="congratulations-modal">
    <div class="modal-content">
      <div class="modal-body">
        <i class="fa-solid fa-trophy confetti-icon"></i>
        <h2 id="congrats-title">Цель достигнута!</h2>
        <p>Поздравляем с завершением задачи! Что будем делать дальше?</p>
        <div class="congrats-actions">
            <button class="btn secondary" id="btn-congrats-cancel"><i class="fa-solid fa-rotate-left"></i> Оставить активной</button>
            <button class="btn primary" id="btn-congrats-done"><i class="fa-solid fa-check"></i> В завершенные</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="confirm-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Подтвердите</h2><span class="modal-close"><i class="fa-solid fa-xmark"></i></span></div>
      <div class="modal-body"><p id="confirm-text"></p></div>
      <div class="modal-actions"><button class="btn secondary" id="confirm-cancel">Отмена</button><button class="btn danger" id="confirm-ok">ОК</button></div>
    </div>
  </div>

<script>
(() => {
  // --- CONFIG ---
  const SUPABASE_URL = 'https://mljfqhczwxflwezgvkcv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1samZxaGN6d3hmbHdlemd2a2N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzODI1MDAsImV4cCI6MjA4MTk1ODUwMH0.S3empDGZqo8s6-BhSt5ziA0EC0sGvQgkXDDq-t2JuOs';
  const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  let user = null;

  let DATA = { goals: [] };
  let currentEditId = null;
  let currentProgressId = null;
  
  // Переменные для истории
  let hCurrentGoalId = null;
  let hLimit = 10;
  let hFilterDate = null;
  let hPicker = null;

  let confirmAction = null;
  let congratsGoalId = null; 
  let selectedGoalIds = new Set();
  
  const authScreen = document.getElementById('auth-screen');
  const appContent = document.getElementById('app-content');
  const userEmailDisplay = document.getElementById('user-email-display');

  // --- SAFE ID GENERATOR ---
  function generateId() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) { return crypto.randomUUID(); }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
  }

  function nowISO() { return new Date().toISOString(); }
  function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toast-message').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  // --- DB HELPERS ---
  function toDbFormat(goal, userId) {
      return {
          id: goal.id, user_id: userId, title: goal.title, target: goal.target,
          current: goal.current, deadline: goal.deadline, priority: goal.priority,
          notes: goal.notes, is_done: goal.status === 'done', is_trash: goal.status === 'trash',
          is_favorite: goal.isFavorite, is_pinned: goal.isPinned, history: goal.history,
          created_at: goal.createdAt, updated_at: goal.updatedAt
      };
  }
  function toLocalFormat(dbGoal) {
      let status = 'active';
      if (dbGoal.is_trash) status = 'trash';
      else if (dbGoal.is_done) status = 'done';
      return {
          id: dbGoal.id, title: dbGoal.title, target: dbGoal.target, current: dbGoal.current,
          deadline: dbGoal.deadline, priority: dbGoal.priority, notes: dbGoal.notes,
          status: status, isFavorite: dbGoal.is_favorite, isPinned: dbGoal.is_pinned,
          history: dbGoal.history || [], createdAt: dbGoal.created_at, updatedAt: dbGoal.updated_at
      };
  }

  // --- SYNC ---
  async function syncGoalToCloud(goal) {
      if (!user || !sb) return;
      await sb.from('goals').upsert(toDbFormat(goal, user.id));
  }
  async function deleteGoalFromCloud(id) {
      if (!user || !sb) return;
      await sb.from('goals').delete().eq('id', id).eq('user_id', user.id);
  }

  async function loadData() {
    if (!user || !sb) {
        DATA.goals = []; // СТРОГИЙ РЕЖИМ: Если нет юзера, нет данных.
        return;
    }
    const { data, error } = await sb.from('goals').select('*').eq('user_id', user.id);
    if (!error && data) {
        DATA.goals = data.map(toLocalFormat);
    }
  }

  // --- AUTH FLOW ---
  async function initAuth() {
    if (!sb) return;
    const { data: { session } } = await sb.auth.getSession();
    handleSession(session);

    sb.auth.onAuthStateChange(async (event, session) => {
        handleSession(session);
        if (event === 'SIGNED_OUT') {
            DATA.goals = []; // Очистка при выходе
            render();
            showToast('Вы вышли из системы');
        }
    });
  }

  async function handleSession(session) {
      user = session?.user || null;
      if (user) {
          // Logged In
          authScreen.style.opacity = '0';
          setTimeout(() => authScreen.style.display = 'none', 300);
          appContent.style.display = 'block';
          userEmailDisplay.textContent = user.email;
          
          await loadData(); // Грузим ТОЛЬКО из облака
          render();
      } else {
          // Logged Out
          authScreen.style.display = 'flex';
          authScreen.style.opacity = '1';
          appContent.style.display = 'none';
      }
  }

  document.getElementById('auth-btn-google').onclick = async () => {
      await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } });
  };
  
  document.getElementById('btn-logout').onclick = async () => {
      await sb.auth.signOut();
  };


  // --- FORMATTING ---
  function safeParseNum(v) {
    if (!v && v !== 0) return 0;
    let str = String(v).replace(/\s+/g, '').replace(/,/g, '.').toLowerCase();
    let multiplier = 1;
    if (str.endsWith('к') || str.endsWith('k')) { str = str.slice(0, -1); multiplier = 1000; }
    else if (str.endsWith('м') || str.endsWith('m')) { str = str.slice(0, -1); multiplier = 1000000; }
    const res = parseFloat(str);
    return isNaN(res) ? 0 : res * multiplier;
  }
  function fmt(n) { return Math.round(safeParseNum(n)).toLocaleString('ru-RU'); }
  
  function formatNumberInput(inputId) {
      const input = document.getElementById(inputId);
      if(!input) return;
      input.addEventListener('blur', (e) => {
         let val = e.target.value.replace(/[^\d.,]/g, '').replace(/,/g,'.');
         let num = parseFloat(val);
         if(!isNaN(num)) e.target.value = new Intl.NumberFormat('ru-RU').format(Math.round(num));
      });
      input.addEventListener('focus', (e) => {
         e.target.value = e.target.value.replace(/\s/g, '');
      });
  }
  ['g-target','g-current','edit-target','edit-current','progress-amount'].forEach(formatNumberInput);

  function declOfNum(n, t) { return t[(n%100>4 && n%100<20)?2 : [2,0,1,1,1,2][(n%10<5)?n%10:5]]; }
  function formatTimeLeft(deadline) {
    if (!deadline) return { text: '<span style="color:var(--text-muted)"><i class="fa-solid fa-infinity"></i></span>', totalHours: null };
    const diffMs = new Date(deadline + 'T23:59:59') - new Date();
    if (diffMs <= 0) {
      const days = Math.ceil(Math.abs(diffMs)/86400000);
      return { text: `<span style="color:var(--red)">Просрочено (${days} дн.)</span>`, totalHours: 0 };
    }
    const days = Math.floor(diffMs/86400000);
    return { text: `Осталось ${days} ${declOfNum(days, ['день','дня','дней'])}`, totalHours: diffMs/3600000 };
  }

  function setupDateTemplate(selId, customId, inpId, resId) {
      const s = document.getElementById(selId), c = document.getElementById(customId), i = document.getElementById(inpId), r = document.getElementById(resId);
      s.addEventListener('change', () => {
          c.style.display = s.value === 'custom' ? 'block' : 'none';
          if(s.value && s.value !== 'custom') {
              const d = new Date(); d.setDate(d.getDate() + parseInt(s.value));
              r.value = d.toISOString().slice(0,10);
          }
      });
      i.addEventListener('input', () => {
         if(i.value) { const d = new Date(); d.setDate(d.getDate() + parseInt(i.value)); r.value = d.toISOString().slice(0,10); }
      });
  }
  setupDateTemplate('g-template','g-custom-days-field','g-custom-days-input','g-deadline');

  // --- UI ACTIONS ---
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  document.querySelectorAll('.modal-close, .modal').forEach(el => el.onclick = e => { if(e.target === el) closeModal(el.closest('.modal').id || el.id); });

  function openConfirmModal(text, cb, destructive=false) {
      document.getElementById('confirm-text').textContent = text;
      confirmAction = cb;
      const btn = document.getElementById('confirm-ok');
      btn.className = destructive ? 'btn danger' : 'btn primary';
      btn.textContent = destructive ? 'Удалить' : 'ОК';
      openModal('confirm-modal');
  }
  document.getElementById('confirm-ok').onclick = () => { if(confirmAction) confirmAction(); closeModal('confirm-modal'); };
  document.getElementById('confirm-cancel').onclick = () => closeModal('confirm-modal');

  function updateMultiAction(visible) {
      const bar = document.getElementById('multi-action-bar');
      const count = selectedGoalIds.size;
      bar.style.display = count > 0 ? 'flex' : 'none';
      document.getElementById('multi-action-text').textContent = `Выбрано: ${count}`;
      
      const cont = bar.querySelector('.multi-action-btns');
      cont.innerHTML = '';
      
      const btnAll = document.createElement('button');
      btnAll.className = 'btn secondary';
      btnAll.innerHTML = `<i class="fa-solid fa-list-check"></i> <span class="desktop-only">${count === visible.length && visible.length>0 ? 'Снять' : 'Все'}</span>`;
      btnAll.onclick = () => {
          if (count === visible.length && visible.length > 0) selectedGoalIds.clear();
          else visible.forEach(g => selectedGoalIds.add(g.id));
          render();
      };
      cont.appendChild(btnAll);
      
      const btnTrash = document.createElement('button');
      btnTrash.className = 'btn danger';
      btnTrash.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      btnTrash.onclick = () => {
          openConfirmModal(`Удалить ${selectedGoalIds.size} целей?`, () => {
              DATA.goals.filter(g => selectedGoalIds.has(g.id)).forEach(g => {
                  g.status = 'trash'; g.updatedAt = nowISO(); syncGoalToCloud(g);
              });
              selectedGoalIds.clear(); render();
          });
      };
      cont.appendChild(btnTrash);
  }

  // --- RENDER ---
  function render() {
      const list = document.getElementById('goals-list');
      list.innerHTML = '';
      const filter = document.querySelector('.tab.active').dataset.filter;
      
      const visible = DATA.goals.filter(g => {
          if (filter === 'active') return g.status === 'active';
          if (filter === 'done') return g.status === 'done';
          if (filter === 'trash') return g.status === 'trash';
          if (filter === 'favorite') return g.isFavorite && g.status !== 'trash';
          return g.status !== 'trash';
      });

      visible.sort((a,b) => (b.isPinned - a.isPinned));

      if(visible.length === 0) {
          list.innerHTML = '<div class="empty-message"><i class="fa-regular fa-folder-open"></i><span>Пусто</span></div>';
          selectedGoalIds.clear();
      }

      visible.forEach(g => {
          const t = safeParseNum(g.target), c = safeParseNum(g.current);
          const pct = t ? Math.min(100, (c/t)*100).toFixed(0) : 0;
          const {text: dText} = formatTimeLeft(g.deadline);
          
          let pClass = g.priority === 'high' ? 'priority-high' : g.priority === 'low' ? 'priority-low' : 'priority-med';
          let pName = g.priority === 'high' ? 'Высокий' : g.priority === 'low' ? 'Низкий' : 'Средний';

          const el = document.createElement('div');
          el.className = `goal-card ${selectedGoalIds.has(g.id)?'selected':''} ${g.status==='done'?'done':''}`;
          el.onclick = (e) => {
              if(!e.target.closest('button, input, .star-icon, .pin-icon')) {
                  if(selectedGoalIds.has(g.id)) selectedGoalIds.delete(g.id); else selectedGoalIds.add(g.id);
                  render();
              }
          };

          let ctrls = '';
          if (g.status !== 'trash') {
              ctrls = `
               <div class="quick-add"><button class="quick-btn" data-act="prog" data-id="${g.id}">Баланс</button></div>
               <div class="actions-row">
                 <button class="action-icon-btn" data-act="edit" data-id="${g.id}">Ред.</button>
                 <button class="action-icon-btn" data-act="hist" data-id="${g.id}">История</button>
                 <button class="action-icon-btn" data-act="done" data-id="${g.id}">${g.status==='done'?'Вернуть':'Готово'}</button>
                 <button class="action-icon-btn delete" data-act="del" data-id="${g.id}" style="margin-left:auto"><i class="fa-regular fa-trash-can"></i></button>
               </div>`;
          } else {
              ctrls = `<div class="actions-row"><button class="action-icon-btn" data-act="rest" data-id="${g.id}">Восстановить</button><button class="action-icon-btn delete" data-act="kill" data-id="${g.id}" style="margin-left:auto">Удалить навсегда</button></div>`;
          }

          el.innerHTML = `
            <div class="goal-header">
                <div class="goal-title-wrapper">
                    <i class="fa-${g.isFavorite?'solid':'regular'} fa-star star-icon ${g.isFavorite?'active':''}" data-act="fav" data-id="${g.id}"></i>
                    <i class="fa-solid fa-thumbtack pin-icon ${g.isPinned?'active':''}" data-act="pin" data-id="${g.id}"></i>
                    <div class="goal-title" style="margin-left:4px">${g.title}</div>
                </div>
                <div class="priority-badge ${pClass}">${pName}</div>
            </div>
            <div class="goal-meta"><i class="fa-regular fa-clock"></i> ${dText}</div>
            <div class="progress-bar ${g.status==='done'?'done':''}"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div class="numbers"><span>${fmt(c)}</span><span>${fmt(t)} • ${pct}%</span></div>
            ${ctrls}
          `;

          // Handlers
          el.querySelectorAll('[data-act]').forEach(b => b.onclick = (e) => {
              e.stopPropagation();
              const id = b.dataset.id;
              const act = b.dataset.act;
              const gl = DATA.goals.find(x => x.id === id);
              if(!gl) return;

              if(act==='fav') { gl.isFavorite = !gl.isFavorite; syncGoalToCloud(gl); render(); }
              if(act==='pin') { gl.isPinned = !gl.isPinned; syncGoalToCloud(gl); render(); }
              if(act==='edit') { 
                  currentEditId = id;
                  document.getElementById('edit-title').value = gl.title;
                  document.getElementById('edit-target').value = fmt(gl.target);
                  document.getElementById('edit-current').value = fmt(gl.current);
                  document.getElementById('edit-deadline').value = gl.deadline || '';
                  document.getElementById('edit-priority').value = gl.priority;
                  document.getElementById('edit-notes').value = gl.notes;
                  openModal('edit-modal');
              }
              if(act==='prog') { currentProgressId = id; document.getElementById('progress-amount').value = ''; openModal('progress-modal'); }
              if(act==='hist') { hCurrentGoalId = id; renderHistory(); openModal('history-modal'); }
              if(act==='done') { 
                  if(gl.status !== 'done' && gl.current >= gl.target) {
                      congratsGoalId = id; document.getElementById('congrats-title').textContent = gl.title; openModal('congratulations-modal');
                  } else {
                      gl.status = gl.status === 'done' ? 'active' : 'done';
                      syncGoalToCloud(gl); render();
                  }
              }
              if(act==='del') { gl.status = 'trash'; syncGoalToCloud(gl); render(); }
              if(act==='rest') { gl.status = 'active'; syncGoalToCloud(gl); render(); }
              if(act==='kill') { openConfirmModal('Удалить навсегда?', () => { DATA.goals = DATA.goals.filter(x=>x.id!==id); deleteGoalFromCloud(id); render(); }, true); }
          });

          list.appendChild(el);
      });

      updateMultiAction(visible);
      updateCounts();
  }

  function updateCounts() {
      const all = DATA.goals.filter(g => g.status !== 'trash');
      const act = DATA.goals.filter(g => g.status === 'active');
      const done = DATA.goals.filter(g => g.status === 'done');
      const tr = DATA.goals.filter(g => g.status === 'trash');
      const fav = DATA.goals.filter(g => g.isFavorite && g.status !== 'trash');
      
      document.getElementById('active-count').textContent = act.length;
      document.getElementById('done-count').textContent = done.length;
      document.getElementById('trash-count').textContent = tr.length;
      document.getElementById('fav-count').textContent = fav.length;
      document.getElementById('total-count').textContent = all.length;

      const tT = act.reduce((s,g)=>s+g.target,0);
      const tC = act.reduce((s,g)=>s+g.current,0);
      const p = tT ? (tC/tT)*100 : 0;
      document.getElementById('overall-progress').style.width = p + '%';
      document.getElementById('overall-text').textContent = `${fmt(tC)} из ${fmt(tT)}`;
  }

  // --- SAVE ACTIONS ---
  document.getElementById('btn-add').onclick = () => {
      const t = document.getElementById('g-title').value.trim();
      if(!t) return showToast('Введите название');
      const tg = safeParseNum(document.getElementById('g-target').value);
      const cur = safeParseNum(document.getElementById('g-current').value);
      
      const g = {
          id: generateId(), title: t, target: tg, current: cur,
          deadline: document.getElementById('g-deadline').value || null,
          priority: document.getElementById('g-priority').value,
          notes: document.getElementById('g-notes').value,
          status: (tg>0 && cur>=tg) ? 'done' : 'active',
          isFavorite: false, isPinned: false, history: [],
          createdAt: nowISO(), updatedAt: nowISO()
      };
      if(cur > 0) g.history.push({id: generateId(), date: nowISO(), amount: cur, comment: 'Начало'});
      
      DATA.goals.push(g);
      syncGoalToCloud(g);
      render();
      showToast('Цель создана');
      
      // Clear
      ['g-title','g-target','g-current','g-deadline','g-notes'].forEach(i=>document.getElementById(i).value='');
  };

  document.getElementById('btn-demo').onclick = () => {
     if(DATA.goals.filter(g=>g.status==='active').length > 0) return showToast('Активные цели уже есть');
     const d = [
         {t:'iPhone 16', trg:120000, c:10000, p:'med'},
         {t:'Бали', trg:200000, c:45000, p:'high'}
     ];
     d.forEach(x => {
         const g = { id: generateId(), title: x.t, target: x.trg, current: x.c, priority: x.p, status: 'active', history:[], createdAt: nowISO(), updatedAt: nowISO() };
         if(x.c>0) g.history.push({id:generateId(), date:nowISO(), amount:x.c, comment:'Старт'});
         DATA.goals.push(g);
         syncGoalToCloud(g);
     });
     render();
  };

  document.getElementById('save-edit').onclick = () => {
      const g = DATA.goals.find(x => x.id === currentEditId);
      if(!g) return;
      
      const oldC = g.current;
      g.title = document.getElementById('edit-title').value;
      g.target = safeParseNum(document.getElementById('edit-target').value);
      g.current = safeParseNum(document.getElementById('edit-current').value);
      g.deadline = document.getElementById('edit-deadline').value || null;
      g.priority = document.getElementById('edit-priority').value;
      g.notes = document.getElementById('edit-notes').value;
      g.updatedAt = nowISO();
      
      const diff = g.current - oldC;
      if(diff !== 0) g.history.push({id: generateId(), date: nowISO(), amount: diff, comment: 'Редактирование'});
      
      syncGoalToCloud(g);
      render(); closeModal('edit-modal');
  };

  function updateBalance(isSub) {
      const g = DATA.goals.find(x => x.id === currentProgressId);
      const val = safeParseNum(document.getElementById('progress-amount').value);
      if(val <= 0) return;
      const comm = document.getElementById('progress-comment').value || (isSub?'Расход':'Пополнение');
      
      if(isSub) g.current = Math.max(0, g.current - val);
      else g.current += val;
      
      g.history.push({id: generateId(), date: nowISO(), amount: isSub ? -val : val, comment: comm});
      g.updatedAt = nowISO();
      
      syncGoalToCloud(g);
      render();
      closeModal('progress-modal');
      
      if(g.current >= g.target && g.status !== 'done') {
           congratsGoalId = g.id; document.getElementById('congrats-title').textContent = g.title; openModal('congratulations-modal');
      }
  }
  document.getElementById('btn-add-progress').onclick = () => updateBalance(false);
  document.getElementById('btn-subtract').onclick = () => updateBalance(true);

  document.getElementById('btn-congrats-done').onclick = () => {
      const g = DATA.goals.find(x=>x.id===congratsGoalId);
      if(g) { g.status = 'done'; syncGoalToCloud(g); render(); }
      closeModal('congratulations-modal');
  };
  document.getElementById('btn-congrats-cancel').onclick = () => closeModal('congratulations-modal');

  // --- HISTORY VIEW ---
  function renderHistory() {
      const c = document.getElementById('history-list-container');
      c.innerHTML = '';
      const g = DATA.goals.find(x => x.id === hCurrentGoalId);
      if(!g || !g.history.length) return c.innerHTML = '<div class="empty-message">Нет записей</div>';
      
      let h = [...g.history].sort((a,b)=>new Date(b.date)-new Date(a.date));
      h.forEach(i => {
          const d = document.createElement('div');
          d.className = 'history-item';
          const isP = i.amount > 0;
          d.innerHTML = `
            <div class="history-info">
                <div class="history-comment">${i.comment}</div>
                <div class="history-date">${new Date(i.date).toLocaleString()}</div>
            </div>
            <div class="history-amount ${isP?'plus':'minus'}">${isP?'+':''}${fmt(i.amount)}</div>
          `;
          c.appendChild(d);
      });
  }

  // --- TABS ---
  document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      selectedGoalIds.clear();
      render();
  });
  
  document.getElementById('theme-btn').onclick = () => {
      const curr = document.body.dataset.theme;
      document.body.dataset.theme = curr === 'dark' ? '' : 'dark';
      localStorage.setItem('theme', document.body.dataset.theme); // Theme is okay to persist locally
  };
  document.body.dataset.theme = localStorage.getItem('theme') || '';

  // Start
  initAuth();

})();
</script>
</body>
</html>
